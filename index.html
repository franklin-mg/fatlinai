<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fatlin AI - Comunidad Digital FATLA</title>
    <meta name="theme-color" content="#0ea5e9">
    <link rel="manifest" href="data:application/manifest+json,{%22name%22:%22Fatlin%20AI%22,%22short_name%22:%22Fatlin%22,%22start_url%22:%22.%22,%22display%22:%22standalone%22,%22background_color%22:%22#0ea5e9%22,%22theme_color%22:%22#0ea5e9%22}">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&display=swap');
        body { font-family: 'Fredoka', sans-serif; background-color: #f0f2f5; margin: 0; display: flex; justify-content: center; overflow: hidden; -webkit-tap-highlight-color: transparent; }
        #app-container { width: 100%; max-width: 500px; background: white; height: 100vh; display: flex; flex-direction: column; position: relative; box-shadow: 0 0 40px rgba(0,0,0,0.1); }
        #splash-screen { position: absolute; inset: 0; background: #0ea5e9; z-index: 200; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; transition: opacity 0.5s ease-out; }
        .splash-logo { width: 120px; height: 120px; background: white; border-radius: 30px; display: flex; align-items: center; justify-content: center; box-shadow: 0 20px 40px rgba(0,0,0,0.2); margin-bottom: 20px; animation: pulse-logo 2s infinite ease-in-out; }
        @keyframes pulse-logo { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        .path-container { display: flex; flex-direction: column; align-items: center; padding: 40px 0 140px 0; gap: 40px; background-image: radial-gradient(#e2e8f0 1px, transparent 1px); background-size: 20px 20px; }
        .level-node { position: relative; z-index: 2; }
        .level-node:nth-child(odd) { transform: translateX(-40px); }
        .level-node:nth-child(even) { transform: translateX(40px); }
        .level-node.is-current { transform: translateX(0) scale(1.1); z-index: 10; }
        .level-btn { width: 70px; height: 70px; border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 24px; font-weight: 700; border-bottom: 6px solid rgba(0,0,0,0.2); transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); cursor: pointer; }
        .level-btn.locked { background: #cbd5e1; color: #94a3b8; border-bottom-color: #94a3b8; cursor: not-allowed; }
        .level-btn.current { background: #0ea5e9; color: white; border-bottom-color: #0369a1; box-shadow: 0 10px 20px rgba(14, 165, 233, 0.3); }
        .level-btn.completed { background: #22c55e; color: white; border-bottom-color: #15803d; }
        .feedback-overlay { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%) translateY(100%); width: 100%; max-width: 500px; padding: 2rem; border-radius: 2rem 2rem 0 0; transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 60; }
        .feedback-overlay.show { transform: translateX(-50%) translateY(0); }
        #modals-container > div { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); z-index: 150; align-items: center; justify-content: center; padding: 20px; }
        .mascot-pointer { position: absolute; top: -45px; left: 50%; transform: translateX(-50%); background: #f59e0b; color: white; padding: 4px 12px; border-radius: 12px; font-size: 10px; font-weight: 800; white-space: nowrap; box-shadow: 0 4px 12px rgba(0,0,0,0.2); animation: bounce 2s infinite; }
        @keyframes bounce { 0%, 100% { transform: translateX(-50%) translateY(0); } 50% { transform: translateX(-50%) translateY(-10px); } }
        .star-pill { background: rgba(245, 158, 11, 0.1); color: #d97706; padding: 4px 10px; border-radius: 12px; border: 1px solid rgba(245, 158, 11, 0.2); font-size: 11px; font-weight: 800; display: flex; align-items: center; gap: 4px; }
        .shake-animation { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
    </style>
</head>
<body>
    <div id="app-container">
        <!-- Splash Screen -->
        <div id="splash-screen">
            <div class="splash-logo">
                <svg class="w-20 h-20 text-sky-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                </svg>
            </div>
            <h1 class="text-3xl font-black mb-1">Fatlin AI</h1>
            <p class="text-sky-100 font-bold opacity-80 uppercase tracking-widest text-xs">Cargando Planeta FATLA...</p>
        </div>

        <!-- Modales -->
        <div id="modals-container">
            <div id="trophy-modal">
                <div class="bg-white p-8 rounded-[3rem] text-center max-w-sm w-full border-4 border-slate-50">
                    <div id="trophy-icon" class="text-8xl mb-4">üèÜ</div>
                    <h2 class="text-2xl font-black text-slate-800" id="trophy-title">¬°NUEVO TROFEO!</h2>
                    <p class="text-slate-500 font-medium mt-2 mb-6" id="trophy-desc">Has desbloqueado un nuevo logro PACIE.</p>
                    <button onclick="closeModal('trophy-modal')" class="w-full py-4 bg-sky-500 text-white font-black rounded-2xl shadow-lg active:scale-95">¬°FANT√ÅSTICO!</button>
                </div>
            </div>

            <div id="history-modal">
                <div class="bg-white rounded-[3rem] w-full max-sm p-8 shadow-2xl border-4 border-slate-50">
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <h3 class="text-2xl font-black text-slate-800">Mis Trofeos</h3>
                            <p class="text-[10px] font-bold text-sky-500">PROGRESO PACIE</p>
                        </div>
                        <button onclick="closeModal('history-modal')" class="text-slate-400 font-bold">‚úï</button>
                    </div>
                    <div id="trophy-grid" class="grid grid-cols-3 gap-4 max-h-[40vh] overflow-y-auto"></div>
                </div>
            </div>

            <div id="ranking-modal">
                <div class="bg-white rounded-[3rem] w-full max-sm p-8 shadow-2xl border-4 border-slate-50">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-black text-slate-800">Top Exploradores</h3>
                        <button onclick="closeModal('ranking-modal')" class="text-slate-400 font-bold">‚úï</button>
                    </div>
                    <div id="ranking-list" class="space-y-3 max-h-[50vh] overflow-y-auto"></div>
                </div>
            </div>

            <div id="error-modal">
                <div class="bg-white p-8 rounded-[3rem] text-center max-w-sm w-full">
                    <div class="text-6xl mb-4">üõ∞Ô∏è</div>
                    <h2 class="text-xl font-black text-slate-800">Problema de Se√±al</h2>
                    <p class="text-slate-500 text-sm mt-2 mb-6">No se pudo contactar con el Planeta FATLA. Verifica tu conexi√≥n.</p>
                    <button onclick="location.reload()" class="w-full py-4 bg-slate-800 text-white font-black rounded-2xl">REINTENTAR</button>
                </div>
            </div>
        </div>

        <header class="bg-white border-b-2 border-slate-100 px-4 py-4 flex flex-col gap-3 sticky top-0 z-50">
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <div class="w-10 h-10 bg-sky-600 rounded-xl flex items-center justify-center text-white shadow-lg rotate-3">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" class="w-6 h-6"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
                    </div>
                    <div>
                        <h1 class="text-lg font-black text-slate-800 leading-none">Fatlin AI</h1>
                        <p class="text-[9px] font-bold text-sky-500 uppercase tracking-widest mt-1">v1.0 Gold</p>
                    </div>
                </div>
                
                <div class="flex gap-2">
                    <button onclick="showHistory()" class="bg-sky-50 p-2.5 rounded-xl border-2 border-sky-100 shadow-sm active:scale-90">üèÖ</button>
                    <button onclick="showRanking()" class="bg-amber-50 p-2.5 rounded-xl border-2 border-amber-100 shadow-sm active:scale-90">üèÜ</button>
                    <div class="bg-rose-50 px-3 py-1.5 rounded-xl border-2 border-rose-100 flex flex-col items-center min-w-[60px]">
                        <span id="lives-text" class="font-black text-rose-700 text-xs">‚ù§Ô∏è 5</span>
                        <span id="timer-text" class="text-[8px] font-bold text-rose-400 hidden">00:00</span>
                    </div>
                </div>
            </div>
        </header>

        <main id="game-content" class="flex-1 overflow-y-auto relative bg-slate-50">
            <div id="view-loading" class="absolute inset-0 flex flex-col items-center justify-center p-10 bg-white/80 backdrop-blur-sm z-40 hidden">
                <div class="w-12 h-12 border-4 border-sky-500 border-t-transparent rounded-full animate-spin"></div>
                <p class="text-slate-500 font-bold mt-4 animate-pulse">Consultando a Fatlin...</p>
            </div>
            
            <div id="view-map">
                <div class="bg-gradient-to-r from-sky-600 to-sky-500 p-6 text-white text-center shadow-lg">
                    <h2 id="stage-title" class="text-[10px] font-black uppercase tracking-[0.3em] mb-1 opacity-70">FASE ACTUAL</h2>
                    <p id="stage-desc" class="text-lg font-bold">Metodolog√≠a PACIE en el Aula</p>
                </div>
                <div class="path-container" id="levels-path"></div>
            </div>

            <div id="view-quiz" class="hidden h-full p-6 flex flex-col bg-white">
                <div class="max-w-md mx-auto w-full flex-1 flex flex-col">
                    <div class="mb-8 flex items-center gap-4">
                        <button onclick="exitQuiz()" class="text-slate-300 hover:text-rose-500 font-black text-2xl">‚úï</button>
                        <div class="h-3 flex-1 bg-slate-100 rounded-full overflow-hidden">
                            <div id="quiz-progress" class="h-full bg-sky-500 transition-all duration-500" style="width: 0%"></div>
                        </div>
                    </div>
                    <div id="question-card" class="bg-sky-50 rounded-[2.5rem] p-8 mb-8 border-4 border-white shadow-xl shadow-sky-100">
                        <h2 id="question-text" class="text-xl font-bold text-slate-800 text-center"></h2>
                    </div>
                    <div id="options-container" class="space-y-3"></div>
                </div>
            </div>
        </main>

        <div id="feedback-panel" class="feedback-overlay bg-white shadow-[0_-15px_40px_rgba(0,0,0,0.1)]">
            <div class="flex flex-col gap-4">
                <div id="feedback-msg" class="text-2xl font-black text-center"></div>
                <p id="feedback-justification" class="text-sm font-medium text-slate-500 text-center"></p>
                <button id="btn-next" class="w-full py-5 text-white font-black text-xl rounded-[1.5rem] shadow-xl active:scale-95 transition-all">CONTINUAR</button>
            </div>
        </div>

        <footer class="bg-slate-900 px-6 py-4 flex justify-between items-center">
            <div class="flex flex-col">
                <span id="user-id-tag" class="text-[9px] font-bold text-slate-400 uppercase">ID: ---</span>
                <span class="text-[8px] font-medium text-slate-500">TECNOTIPS ¬© 2026</span>
            </div>
            <div class="flex gap-4">
                <div class="star-pill">‚≠ê <span id="footer-stars-text">0</span></div>
                <div class="star-pill">üåê <span id="score-text">0</span></div>
            </div>
        </footer>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, getDocs } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'fatlin-v1-gold';
        const apiKey = ""; // API Key de Gemini (inyectada por el entorno)

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const REGEN_TIME = 5 * 60 * 1000; // 5 minutos por vida
        const SYSTEM_PROMPT = `Act√∫a como Fatlin, tutor del Planeta FATLA. Genera desaf√≠os educativos breves sobre metodolog√≠a PACIE y educaci√≥n virtual.
        Debes responder EXCLUSIVAMENTE en formato JSON: {"questions":[{"q":"pregunta","options":["A","B","C"],"correct":0,"justification":"explicaci√≥n"}]}`;

        const TROPHIES = [
            { level: 5, name: "Iniciaci√≥n PACIE", icon: "üå±" },
            { level: 10, name: "Papel Reciclado", icon: "üìÑ" },
            { level: 25, name: "Plata de FATLA", icon: "ü•à" },
            { level: 50, name: "Diamante Digital", icon: "‚ú®" }
        ];

        let state = {
            user: null,
            progress: { level: 1, lives: 5, score: 0, stars: 0, lastLifeLoss: Date.now(), trophies: [] },
            currentQuiz: [],
            quizIndex: 0,
            playingLevel: 0,
            isAnswering: false
        };

        async function init() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (e) {
                document.getElementById('error-modal').style.display = 'flex';
            }
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                state.user = user;
                document.getElementById('user-id-tag').textContent = `ID: ${user.uid.substring(0,10)}...`;
                setupSync(user.uid);
            }
        });

        function setupSync(uid) {
            const ref = doc(db, 'artifacts', appId, 'users', uid, 'progress', 'main');
            onSnapshot(ref, (snap) => {
                if (snap.exists()) {
                    state.progress = snap.data();
                    updateLives();
                    updateUI();
                } else {
                    saveProgress();
                }
                document.getElementById('splash-screen').style.opacity = '0';
                setTimeout(() => document.getElementById('splash-screen').style.display = 'none', 500);
            }, (err) => {
                console.error("Sync error:", err);
            });
        }

        async function fetchQuestions(level) {
            const prompt = `Genera 3 preguntas de nivel ${level} sobre FATLA y PACIE. Cada pregunta debe tener 3 opciones.`;
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        systemInstruction: { parts: [{ text: SYSTEM_PROMPT }] },
                        generationConfig: { responseMimeType: "application/json" }
                    })
                });
                const data = await res.json();
                return JSON.parse(data.candidates[0].content.parts[0].text).questions;
            } catch (e) {
                throw new Error("API Gemini Error");
            }
        }

        window.startMission = async (level) => {
            if (state.progress.lives <= 0) {
                if(navigator.vibrate) navigator.vibrate([50, 50]);
                return;
            }
            state.playingLevel = level;
            showLoading(true);
            try {
                state.currentQuiz = await fetchQuestions(level);
                state.quizIndex = 0;
                renderQuiz();
                showView('quiz');
            } catch (e) {
                document.getElementById('error-modal').style.display = 'flex';
            } finally {
                showLoading(false);
            }
        };

        function renderQuiz() {
            const q = state.currentQuiz[state.quizIndex];
            state.isAnswering = true;
            document.getElementById('question-text').textContent = q.q;
            document.getElementById('quiz-progress').style.width = `${((state.quizIndex + 1) / state.currentQuiz.length) * 100}%`;
            
            const container = document.getElementById('options-container');
            container.innerHTML = '';
            q.options.forEach((opt, i) => {
                const btn = document.createElement('button');
                btn.className = "w-full p-5 rounded-2xl text-left font-bold text-slate-700 bg-white border-2 border-slate-100 shadow-sm transition-all active:scale-95";
                btn.textContent = opt;
                btn.onclick = () => checkAnswer(i, btn);
                container.appendChild(btn);
            });
        }

        function checkAnswer(idx, btn) {
            if (!state.isAnswering) return;
            state.isAnswering = false;
            const q = state.currentQuiz[state.quizIndex];
            const correct = idx === q.correct;

            if (correct) {
                btn.classList.add('bg-green-50', 'border-green-500', 'text-green-700');
                state.progress.score += 50;
            } else {
                btn.classList.add('bg-rose-50', 'border-rose-500', 'text-rose-700', 'shake-animation');
                if (state.progress.lives === 5) state.progress.lastLifeLoss = Date.now();
                state.progress.lives = Math.max(0, state.progress.lives - 1);
            }
            showFeedback(correct, q.justification);
            saveProgress();
        }

        function showFeedback(ok, text) {
            const panel = document.getElementById('feedback-panel');
            const msg = document.getElementById('feedback-msg');
            msg.textContent = ok ? "¬°EXCELENTE!" : "¬°APRENDIZAJE!";
            msg.className = `text-2xl font-black text-center ${ok ? 'text-green-600' : 'text-rose-600'}`;
            document.getElementById('feedback-justification').textContent = text;
            panel.classList.add('show');

            document.getElementById('btn-next').onclick = () => {
                panel.classList.remove('show');
                if (state.progress.lives <= 0) {
                    showView('map');
                    return;
                }
                if (state.quizIndex < state.currentQuiz.length - 1) {
                    state.quizIndex++;
                    renderQuiz();
                } else {
                    completeLevel();
                }
            };
        }

        function completeLevel() {
            if (state.playingLevel === state.progress.level) {
                state.progress.level++;
                state.progress.stars += 5;
                const trophy = TROPHIES.find(t => t.level === state.playingLevel);
                if (trophy && !state.progress.trophies.includes(state.playingLevel)) {
                    state.progress.trophies.push(state.playingLevel);
                    showTrophy(trophy);
                }
            }
            saveProgress();
            showView('map');
        }

        function updateLives() {
            if (state.progress.lives < 5) {
                const now = Date.now();
                const diff = now - state.progress.lastLifeLoss;
                const recovered = Math.floor(diff / REGEN_TIME);
                if (recovered > 0) {
                    state.progress.lives = Math.min(5, state.progress.lives + recovered);
                    state.progress.lastLifeLoss = now - (diff % REGEN_TIME);
                    saveProgress();
                }
                // Mostrar timer
                const timerEl = document.getElementById('timer-text');
                timerEl.classList.remove('hidden');
                const nextLife = REGEN_TIME - (diff % REGEN_TIME);
                const s = Math.floor((nextLife / 1000) % 60);
                const m = Math.floor((nextLife / 60000));
                timerEl.textContent = `${m}:${s < 10 ? '0' : ''}${s}`;
            } else {
                document.getElementById('timer-text').classList.add('hidden');
            }
        }

        function updateUI() {
            document.getElementById('lives-text').textContent = `‚ù§Ô∏è ${state.progress.lives}`;
            document.getElementById('score-text').textContent = state.progress.score;
            document.getElementById('footer-stars-text').textContent = state.progress.stars;

            const path = document.getElementById('levels-path');
            path.innerHTML = '';
            const startLvl = Math.floor((state.progress.level - 1) / 10) * 10 + 1;
            
            for (let i = startLvl; i < startLvl + 10; i++) {
                const isLocked = i > state.progress.level;
                const isCompleted = i < state.progress.level;
                const node = document.createElement('div');
                node.className = `level-node ${i === state.progress.level ? 'is-current' : ''}`;
                node.innerHTML = `
                    <button class="level-btn ${isCompleted ? 'completed' : (isLocked ? 'locked' : 'current')}" ${isLocked ? 'disabled' : ''}>
                        ${i === state.progress.level ? 'üöÄ' : i}
                    </button>
                    ${i === state.progress.level ? '<div class="mascot-pointer">EST√ÅS AQU√ç</div>' : ''}
                `;
                node.querySelector('button').onclick = () => window.startMission(i);
                path.appendChild(node);
            }
        }

        async function saveProgress() {
            if (!state.user) return;
            const ref = doc(db, 'artifacts', appId, 'users', state.user.uid, 'progress', 'main');
            await setDoc(ref, state.progress);
            
            // Guardar en Ranking P√∫blico
            const rankRef = doc(db, 'artifacts', appId, 'public', 'data', 'ranking', state.user.uid);
            await setDoc(rankRef, {
                name: state.user.uid.substring(0, 8),
                score: state.progress.score,
                level: state.progress.level
            });
        }

        window.showRanking = async () => {
            const list = document.getElementById('ranking-list');
            list.innerHTML = '<div class="text-center py-4 animate-pulse">Cargando Planeta...</div>';
            document.getElementById('ranking-modal').style.display = 'flex';
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'ranking'));
            const snap = await getDocs(q);
            let players = [];
            snap.forEach(d => players.push(d.data()));
            players.sort((a,b) => b.score - a.score);
            list.innerHTML = players.map((p, i) => `
                <div class="flex items-center justify-between p-4 bg-slate-50 rounded-2xl">
                    <span class="font-black text-slate-400">#${i+1}</span>
                    <span class="flex-1 px-4 font-bold text-slate-700">Explorador ${p.name}</span>
                    <span class="font-black text-sky-600">${p.score}</span>
                </div>
            `).join('');
        };

        window.showHistory = () => {
            const grid = document.getElementById('trophy-grid');
            grid.innerHTML = TROPHIES.map(t => {
                const owned = state.progress.trophies.includes(t.level);
                return `
                    <div class="flex flex-col items-center p-3 rounded-2xl ${owned ? 'bg-amber-50' : 'bg-slate-100 opacity-30'}">
                        <span class="text-3xl mb-1">${t.icon}</span>
                        <span class="text-[8px] font-black text-center">${t.name}</span>
                    </div>
                `;
            }).join('');
            document.getElementById('history-modal').style.display = 'flex';
        };

        function showTrophy(t) {
            document.getElementById('trophy-icon').textContent = t.icon;
            document.getElementById('trophy-title').textContent = `¬°LOGRO: ${t.name.toUpperCase()}!`;
            document.getElementById('trophy-modal').style.display = 'flex';
        }

        function showLoading(s) { document.getElementById('view-loading').classList.toggle('hidden', !s); }
        function showView(v) {
            document.getElementById('view-map').classList.toggle('hidden', v !== 'map');
            document.getElementById('view-quiz').classList.toggle('hidden', v !== 'quiz');
        }
        window.closeModal = (id) => document.getElementById(id).style.display = 'none';
        window.exitQuiz = () => showView('map');

        setInterval(updateLives, 1000);
        init();
    </script>
</body>
</html>
